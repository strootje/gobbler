language: node_js
node_js: lts/*

services:
- docker

cache:
  npm: true
  directories:
  - $HOME/.pnpm-store/

branches:
  only:
  - master

before_install:
- curl -L https://unpkg.com/@pnpm/self-installer | node

install:
- pnpm i

jobs:
- name: build
  script:
  - pnpm recursive run build
  - (cd ./packages/frontend && pnpm run build:dev && docker build -t gobbler .)
  - docker save -o gobbler-docker-image gobbler
  - openssl aes-256-cbc -K $encrypted_732d4eeb37a7_key -iv $encrypted_732d4eeb37a7_iv -in id_rsa_deployer.enc -out ~/.ssh/id_rsa_deployer -d
  - docker-machine create --generic-ssh-key ~/.ssh/id_rsa_deployer target
  - docker-machine scp ./gobbler-docker-image target:/inbox

before_deploy:
- sudo apt-get -y install docker-machine
- openssl aes-256-cbc -K $encrypted_732d4eeb37a7_key -iv $encrypted_732d4eeb37a7_iv -in id_rsa_deployer.enc -out ~/.ssh/id_rsa_deployer -d
- docker-machine create --generic-ssh-key ~/.ssh/id_rsa_deployer target

deploy:
- provider: script
  on:
    branch: master
  cleanup: false
  script:
  - docker-machine scp ./gobbler-docker-image target:/inbox
  - docker-machine ssh target -- docker load /inbox/gobbler-docker-image
